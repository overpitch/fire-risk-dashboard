<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Admin Portal - Fire Weather Advisory</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href='/static/synoptic-logo.css' rel='stylesheet'>
    <style>
        /* Custom toggle colors for Test Mode */
        .form-check-input.normal-mode {
            background-color: #198754;
            /* Bootstrap green */
            border-color: #198754;
        }

        .form-check-input.test-mode {
            background-color: #dc3545;
            /* Bootstrap red */
            border-color: #dc3545;
        }

        /* Custom accordion styles */
        .accordion-button::after {
            margin-left: 0;
            margin-right: 0.5rem;
            order: -1;
            content: '+';
            background-image: none !important;
            transform: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            width: 24px;
            height: 24px;
            font-family: system-ui;
        }

        .accordion-button:not(.collapsed)::after {
            content: '–';
            transform: none !important;
            background-image: none !important;
        }

        .accordion-button {
            display: flex;
            align-items: center;
            padding-left: 1rem;
        }

        /* Add scrollbar when content is too long */
        .container {
            max-height: 100vh;
            overflow-y: auto;
        }

        /* Cache information styling for admin page */
        .cache-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .cache-info .status-fresh {
            color: #198754;
            font-weight: bold;
        }

        .cache-info .status-stale {
            color: #fd7e14;
            font-weight: bold;
        }

        .cache-info .status-error {
            color: #dc3545;
            font-weight: bold;
        }

        /* PIN input styling */
        .pin-digit {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            margin: 0 5px;
        }

        .pin-display {
            letter-spacing: 5px;
            font-family: monospace;
            font-size: 24px;
        }

        .numpad {
            max-width: 300px;
            margin: 0 auto;
        }

        .numpad-btn {
            width: 70px;
            height: 70px;
            margin: 5px;
            font-size: 24px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="background-color: #003366 !important;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                Fire Weather Advisory — Sierra City, CA
            </a>
            <span class="navbar-text text-light ms-auto">
                Admin Portal
            </span>
            <a class="navbar-brand fw-bold ms-3" href="/">
                <small>Back to Dashboard</small>
            </a>
        </div>
    </nav>

    <div class="container mt-5">
        <!-- PIN Entry Interface -->
        <div id="pinPrompt" class="card mb-4">
            <div class="card-header">Admin Access Required</div>
            <div class="card-body">
                <p>Please enter the Admin PIN to access the portal.</p>

                <div class="mb-3 text-center">
                    <div class="pin-display p-2 border rounded mb-3" id="pinDisplay">****</div>

                    <div class="numpad">
                        <div class="d-flex justify-content-center mb-2">
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('1')">1</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('2')">2</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('3')">3</button>
                        </div>
                        <div class="d-flex justify-content-center mb-2">
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('4')">4</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('5')">5</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('6')">6</button>
                        </div>
                        <div class="d-flex justify-content-center mb-2">
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('7')">7</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('8')">8</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('9')">9</button>
                        </div>
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-danger numpad-btn" onclick="clearPin()">C</button>
                            <button class="btn btn-outline-secondary numpad-btn" onclick="addPinDigit('0')">0</button>
                            <button class="btn btn-success numpad-btn" onclick="submitPin()">✓</button>
                        </div>
                    </div>
                </div>

                <div id="pinError" class="alert alert-danger mt-3" style="display: none;">
                    Invalid PIN. Please try again.
                </div>
            </div>
        </div>

        <!-- Admin Content (initially hidden) -->
        <div id="adminContent" style="display: none;">
            <h2 class="mb-4">Admin Dashboard</h2>

            <div class="accordion" id="adminAccordion">
                <!-- Data Management Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingDataManagement">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseDataManagement" aria-expanded="true"
                            aria-controls="collapseDataManagement">
                            Data Management
                        </button>
                    </h2>
                    <div id="collapseDataManagement" class="accordion-collapse collapse show"
                        aria-labelledby="headingDataManagement">
                        <div class="accordion-body">
                            <h5>Current Data Status:</h5>

                            <div class="mb-3">
                                <div class="d-flex align-items-center mb-3">
                                    <button id="data-status-btn" class="btn btn-sm btn-secondary"
                                        data-bs-toggle="modal" data-bs-target="#dataStatusModal">Data
                                        Status</button>
                                </div>

                                <div id="admin-cache-info" class="cache-info mb-3">Last updated: Loading...</div>

                                <div class="mb-3">
                                    <button id="admin-refresh-btn" class="btn btn-primary"
                                        onclick="adminManualRefresh()">
                                        Refresh Data
                                    </button>
                                </div>

                                <p class="text-muted mt-2">
                                    This will retrieve fresh data from all data sources and update the dashboard.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscriber Management Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSubscribers">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseSubscribers" aria-expanded="false"
                            aria-controls="collapseSubscribers">
                            Subscriber List Management
                        </button>
                    </h2>
                    <div id="collapseSubscribers" class="accordion-collapse collapse"
                        aria-labelledby="headingSubscribers">
                        <div class="accordion-body">
                            <h5>Email Subscribers</h5>
                            <p>Manage email addresses that will receive notifications when weather conditions
                                warrant alerts.</p>

                            <!-- Import Subscribers -->
                            <div class="mb-4">
                                <h6>Import Subscribers</h6>
                                <p>Upload a CSV or XLSX file containing email addresses. The system will look for a
                                    column with
                                    "email" in the header, or use the first column if no header is found.</p>
                                <div class="alert alert-warning">
                                    <strong>Warning:</strong> Importing a new subscriber list will replace all existing
                                    subscribers.
                                </div>
                                <div class="mb-3">
                                    <label for="subscriberFile" class="form-label">Select File</label>
                                    <input class="form-control" type="file" id="subscriberFile"
                                        accept=".csv, .xlsx, .xls">
                                </div>
                                <button id="importButton" class="btn btn-primary" onclick="importSubscribers()">Import
                                    List</button>
                                <div id="importFeedback" class="mt-2"></div>
                            </div>

                            <!-- Active Subscribers List -->
                            <div class="mt-4">
                                <h6>Active Subscribers</h6>
                                <div id="subscriberList" class="border rounded p-3">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading subscribers...</span>
                                        </div>
                                        <p>Loading subscribers...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Testing Section (combines System Settings and Email Alert Testing) -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTesting">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseTesting" aria-expanded="false" aria-controls="collapseTesting">
                            Testing
                        </button>
                    </h2>
                    <div id="collapseTesting" class="accordion-collapse collapse" aria-labelledby="headingTesting">
                        <div class="accordion-body">
                            <!-- System Settings Content -->
                            <h5>Test Mode</h5>
                            <p>Toggle between normal operation and test mode. Test mode uses cached data to
                                simulate a system with limited connectivity.</p>

                            <div class="form-check form-switch d-flex align-items-center mb-3">
                                <span class="me-3"
                                    style="font-size: 0.9rem; min-width: 60px; text-align: right;">Normal</span>
                                <input class="form-check-input normal-mode" type="checkbox" id="testModeToggle"
                                    style="cursor: pointer; margin-left: 0;">
                                <label class="form-check-label ms-2" for="testModeToggle"
                                    style="font-size: 0.9rem;">Test</label>
                            </div>
                            <p id="testModeStatus">Current mode: <span class="badge bg-success">NORMAL</span></p>
                            <div id="testModeResponse" class="alert" style="display: none;"></div>

                            <hr>

                            <!-- Email Alert Testing Content -->
                            <h5>Test Orange-to-Red Alert Emails</h5>
                            <p>Send test emails to simulate a fire risk transition from Orange to Red level.</p>

                            <div class="mb-3">
                                <h6>Select Recipients:</h6>
                                <div id="verifiedEmails" class="mt-2">
                                    <!-- Verified emails will be populated here -->
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading verified emails...</span>
                                </div>
                            </div>

                            <button id="sendTestEmailsBtn" class="btn btn-warning">
                                Send Test Emails
                            </button>

                            <div id="emailTestResults" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Reference Section -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingReference">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseReference" aria-expanded="false"
                            aria-controls="collapseReference">
                            Reference
                        </button>
                    </h2>
                    <div id="collapseReference" class="accordion-collapse collapse"
                        aria-labelledby="headingReference">
                        <div class="accordion-body">
                            <h5>Wind Definitions</h5>
                            <p>Average Winds are over 1 to 2 minutes.</p>
                            <p>Wind Gust is averaged over 3 to 5 seconds and represents a rapid variation of 10mph.</p>
                            
                            <hr> 

                            <h5>Moisture Definitions</h5>
                            <p>Dry Fuel Moisture (DFM) is about immediate risk, while Soil Moisture (SM) helps understand the broader, underlying conditions and seasonal outlook. SM is a better indicator of <strong>seasonal fire potential</strong> and overall landscape dryness or drought conditions. Persistent low SM at this depth suggests widespread stress on vegetation and contributes to conditions favoring larger, more intense fires if an ignition occurs.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- Close container -->

    <!-- Data Status Modal -->
    <div class="modal fade" id="dataStatusModal" tabindex="-1" aria-labelledby="dataStatusModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataStatusModalLabel">Data Status Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="dataStatusModalBody">
                    <!-- Content will be populated by JavaScript -->
                    Loading status details...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PIN handling
        let currentPin = '';

        function addPinDigit(digit) {
            if (currentPin.length < 4) {
                currentPin += digit;
                updatePinDisplay();

                // Auto-submit if we have 4 digits
                if (currentPin.length === 4) {
                    setTimeout(submitPin, 300); // Small delay for better UX
                }
            }
        }

        function clearPin() {
            currentPin = '';
            updatePinDisplay();
            document.getElementById('pinError').style.display = 'none';
        }

        function updatePinDisplay() {
            let displayText = '';
            for (let i = 0; i < 4; i++) {
                if (i < currentPin.length) {
                    displayText += '•'; // Use bullet character instead of actual number for security
                } else {
                    displayText += '*';
                }
            }
            document.getElementById('pinDisplay').textContent = displayText;
        }

        async function submitPin() {
            try {
                // Disable the numpad while validating
                disableNumpad(true);

                // Show loading state
                document.getElementById('pinDisplay').textContent = "Verifying...";

                // Send PIN to server for validation
                const response = await fetch('/admin/validate-pin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pin: currentPin }),
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.valid) {
                    // Set the session cookie
                    document.cookie = `session_token=${result.session_token}; path=/; max-age=3600`;

                    // PIN is correct
                    document.getElementById('pinPrompt').style.display = 'none';
                    document.getElementById('adminContent').style.display = 'block';

                    // Initialize admin content
                    initializeAdminContent();
                } else {
                    // PIN is incorrect
                    document.getElementById('pinError').style.display = 'block';
                    document.getElementById('pinError').textContent = result.error || 'Invalid PIN. Please try again.';

                    // Clear the PIN after a brief delay
                    setTimeout(clearPin, 500);

                    // Add security delay to prevent brute force
                    disableNumpad(1500);
                }
            } catch (error) {
                console.error('Error validating PIN:', error);
                document.getElementById('pinError').style.display = 'block';
                document.getElementById('pinError').textContent = 'Server error. Please try again.';

                // Enable the numpad again
                disableNumpad(false);
            }
        }

        function disableNumpad(disable) {
            const buttons = document.querySelectorAll('.numpad-btn');

            if (typeof disable === 'number') {
                // If a number is passed, disable for that duration
                buttons.forEach(btn => btn.disabled = true);

                setTimeout(() => {
                    buttons.forEach(btn => btn.disabled = false);
                }, disable);
            } else {
                // Otherwise, just set the disabled state directly
                buttons.forEach(btn => btn.disabled = disable);
            }
        }

        // Initialize admin content
        function initializeAdminContent() {
            // Initialize admin dashboard sections
            console.log("Initializing all admin sections...");

            // Initialize the test mode toggle
            const testModeToggle = document.getElementById('testModeToggle');

            // Get current test mode status
            fetchTestModeStatus().then(isTestMode => {
                testModeToggle.checked = isTestMode;
                updateTestModeUI(isTestMode);
            });

            // Add event listener for toggle changes
            testModeToggle.addEventListener('change', function () {
                const isEnabled = this.checked;
                toggleTestMode(isEnabled);
            });

            // Load subscriber list
            loadSubscribers();

            // Initialize email testing section
            initializeEmailTesting();

            // Initialize data management section
            updateDataStatus();
        }

        // Test Mode functions
        async function fetchTestModeStatus() {
            try {
                const response = await fetch('/api/test-mode-status');
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                return data.testModeEnabled || false;
            } catch (error) {
                console.error('Error fetching test mode status:', error);
                return false; // Default to normal mode on error
            }
        }

        async function toggleTestMode(enable) {
            try {
                // Disable toggle while request is in progress
                const toggle = document.getElementById('testModeToggle');
                toggle.disabled = true;

                const response = await fetch('/toggle-test-mode?enable=' + enable, {
                    credentials: 'include' // Include session cookies
                });
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();

                // Show response message
                const responseDiv = document.getElementById('testModeResponse');
                responseDiv.innerHTML = data.message;
                responseDiv.className = 'alert ' + (data.status === 'success' ? 'alert-success' : 'alert-danger');
                responseDiv.style.display = 'block';

                // Update UI
                updateTestModeUI(enable);

                // Re-enable toggle
                toggle.disabled = false;

                // Hide message after delay
                setTimeout(() => {
                    responseDiv.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Error toggling test mode:', error);

                // Show error
                const responseDiv = document.getElementById('testModeResponse');
                responseDiv.innerHTML = 'Error: Failed to toggle test mode. Please try again.';
                responseDiv.className = 'alert alert-danger';
                responseDiv.style.display = 'block';

                // Reset toggle to original state
                document.getElementById('testModeToggle').checked = !enable;
                updateTestModeUI(!enable);

                // Re-enable toggle
                document.getElementById('testModeToggle').disabled = false;
            }
        }

        function updateTestModeUI(isTestMode) {
            const toggle = document.getElementById('testModeToggle');
            const status = document.getElementById('testModeStatus');

            if (isTestMode) {
                toggle.classList.remove('normal-mode');
                toggle.classList.add('test-mode');
                status.innerHTML = 'Current mode: <span class="badge bg-danger">TEST</span>';
            } else {
                toggle.classList.remove('test-mode');
                toggle.classList.add('normal-mode');
                status.innerHTML = 'Current mode: <span class="badge bg-success">NORMAL</span>';
            }
        }

        // Subscriber management functions
        async function loadSubscribers() {
            try {
                const subscriberList = document.getElementById('subscriberList');

                // Show loading state
                subscriberList.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading subscribers...</span>
                        </div>
                        <p>Loading subscribers...</p>
                    </div>
                `;

                // Log when fetching subscribers starts
                console.log('Fetching subscribers...');

                // Fetch subscribers from the backend
                const response = await fetch('/admin/subscribers', {
                    credentials: 'include' // Include session cookies
                });

                console.log('Response status:', response.status);

                // Parse the response first
                const data = await response.json();
                console.log('Response data:', data);

                // Check for server-reported errors
                if (!response.ok) {
                    const errorMessage = data.error || `Server error: ${response.status}`;
                    throw new Error(errorMessage);
                }

                // Check if the response has an error field (our custom error format)
                if (data.error) {
                    throw new Error(data.error);
                }

                const subscribers = data.subscribers || [];

                // Display the subscribers
                if (subscribers.length === 0) {
                    subscriberList.innerHTML = '<p class="text-muted">No subscribers found. Import a list to add subscribers.</p>';
                } else {
                    let html = `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Email Address</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    subscribers.forEach((email, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${email}</td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                        <p class="text-muted">Total: ${subscribers.length} subscribers</p>
                    `;

                    subscriberList.innerHTML = html;
                }

            } catch (error) {
                console.error('Error loading subscribers:', error);
                document.getElementById('subscriberList').innerHTML =
                    `<div class="alert alert-danger">
                        <h6>Failed to load subscribers</h6>
                        <p>${error.message || 'Unknown error. Please try again later.'}</p>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadSubscribers()">Retry</button>
                     </div>`;
            }
        }

        async function importSubscribers() {
            const fileInput = document.getElementById('subscriberFile');
            const feedbackDiv = document.getElementById('importFeedback');
            const importButton = document.getElementById('importButton');
            const subscriberList = document.getElementById('subscriberList');

            if (!fileInput.files || fileInput.files.length === 0) {
                feedbackDiv.innerHTML = '<div class="alert alert-warning">Please select a file to import.</div>';
                return;
            }

            // Disable button and show loading state
            importButton.disabled = true;
            feedbackDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Uploading and processing file...</span>
                    </div>
                </div>
            `;

            // Show loading state in the subscriber list area too
            subscriberList.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Updating subscribers...</span>
                    </div>
                    <p>Importing subscribers, please wait...</p>
                </div>
            `;

            try {
                // Create form data for the file upload
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                // Send the file to the server
                const response = await fetch('/admin/import-subscribers', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' // Include session cookies
                });

                // Parse the response
                const result = await response.json();

                // Handle success or error
                if (response.ok && result.status === 'success') {
                    feedbackDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>Import Successful</h6>
                            <ul>
                                <li>Emails in file: ${result.total}</li>
                                <li>Valid emails: ${result.valid}</li>
                                <li>Invalid emails: ${result.invalid}</li>
                                <li>Successfully imported: ${result.imported}</li>
                                <li>Failed to import: ${result.failed}</li>
                            </ul>
                        </div>
                    `;

                    // Clear the file input
                    fileInput.value = '';

                    // Add a small delay before refreshing the subscriber list to ensure
                    // the database transaction is fully complete
                    setTimeout(() => {
                        loadSubscribers();
                    }, 500);
                } else {
                    // Show error message
                    const errorMessage = result.error || 'Unknown error occurred during import';
                    feedbackDiv.innerHTML = `<div class="alert alert-danger">Import failed: ${errorMessage}</div>`;

                    // Refresh subscriber list to show original state
                    loadSubscribers();
                }
            } catch (error) {
                console.error('Error during import:', error);
                feedbackDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <p>Error uploading file: ${error.message || 'Could not complete the import operation'}</p>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="importSubscribers()">Retry</button>
                    </div>`;

                // Refresh subscriber list to show original state
                loadSubscribers();
            } finally {
                // Re-enable the import button
                importButton.disabled = false;
            }
        }

        // Email testing functions
        async function loadSubscribersForEmails() {
            const verifiedEmailsDiv = document.getElementById('verifiedEmails');

            try {
                // Show loading state
                verifiedEmailsDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Loading subscribers...</span>
                    </div>
                `;

                // Fetch subscribers from the backend
                const response = await fetch('/admin/subscribers', {
                    credentials: 'include' // Include session cookies
                });

                // Parse the response
                const data = await response.json();

                // Check for errors
                if (!response.ok || data.error) {
                    throw new Error(data.error || `Server error: ${response.status}`);
                }

                const subscribers = data.subscribers || [];

                // Display the subscribers as checkboxes
                if (subscribers.length === 0) {
                    verifiedEmailsDiv.innerHTML = '<p class="text-muted">No subscribers found. Add subscribers first to send test emails.</p>';
                } else {
                    let html = '<div class="mt-2">';

                    subscribers.forEach(email => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input verified-email-checkbox" type="checkbox" value="${email}" id="email-${email.replace('@', '-at-')}">
                                <label class="form-check-label" for="email-${email.replace('@', '-at-')}">
                                    ${email}
                                </label>
                            </div>
                        `;
                    });

                    html += '</div>';
                    verifiedEmailsDiv.innerHTML = html;
                    console.log("Loaded subscribers for emails:", subscribers.length);
                }
            } catch (error) {
                console.error('Error loading subscribers for emails:', error);
                verifiedEmailsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <p>Error loading subscribers: ${error.message || 'Unknown error'}</p>
                        <button class="btn btn-sm btn-outline-danger mt-2" onclick="loadSubscribersForEmails()">Retry</button>
                    </div>
                `;
            }
        }

        async function sendTestEmails() {
            const resultDiv = document.getElementById('emailTestResults');
            const sendButton = document.getElementById('sendTestEmailsBtn');

            // Get selected emails
            const selectedEmails = [];
            document.querySelectorAll('.verified-email-checkbox:checked').forEach(checkbox => {
                selectedEmails.push(checkbox.value);
            });

            if (selectedEmails.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select at least one email recipient.</div>';
                resultDiv.style.display = 'block';
                return;
            }

            // Disable button and show loading state
            sendButton.disabled = true;
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span>Sending test emails...</span>
                    </div>
                </div>
            `;
            resultDiv.style.display = 'block';

            try {
                console.log('Sending test emails to:', selectedEmails);

                // Send request to backend
                const response = await fetch('/admin/test-email-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ emails: selectedEmails }),
                    credentials: 'include'
                });

                // Parse response
                const result = await response.json();

                // Display result
                if (response.ok && result.success) {
                    let html = `
                        <div class="alert alert-success">
                            <h6>Test Emails Sent</h6>
                            <p>${result.message}</p>
                            <hr>
                            <h6>Details:</h6>
                            <ul>
                    `;

                    result.results.forEach(item => {
                        const statusClass = item.status === 'success' ? 'text-success' : 'text-danger';
                        const statusText = item.status === 'success' ? 'Success' : 'Failed';
                        const errorInfo = item.error ? `: ${item.error}` : '';

                        html += `
                            <li>
                                <strong>${item.email}</strong>: 
                                <span class="${statusClass}">${statusText}${errorInfo}</span>
                            </li>
                        `;
                    });

                    html += `
                            </ul>
                        </div>
                    `;

                    resultDiv.innerHTML = html;
                } else {
                    // Show error message
                    const errorMessage = result.error || 'Unknown error occurred';
                    resultDiv.innerHTML = `<div class="alert alert-danger">Failed to send test emails: ${errorMessage}</div>`;
                }
            } catch (error) {
                console.error('Error sending test emails:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <p>Error: ${error.message || 'Could not complete the operation'}</p>
                    </div>`;
            } finally {
                // Re-enable button
                sendButton.disabled = false;
            }
        }

        // Initialize email testing when admin content loads
        function initializeEmailTesting() {
            // Load subscribers immediately
            loadSubscribersForEmails();
            document.getElementById('sendTestEmailsBtn').addEventListener('click', sendTestEmails);
            console.log("Email testing initialized");
        }

        // Data Management functions
        async function updateDataStatus() {
            try {
                const statusBtn = document.getElementById('data-status-btn');
                const cacheInfoDiv = document.getElementById('admin-cache-info');

                // Fetch the current data status
                const response = await fetch('/fire-risk', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();

                // Update cache information
                if (data.cache_info) {
                    // Parse the ISO string with timezone info
                    const lastUpdated = new Date(data.cache_info.last_updated);

                    // Check if any data is older than 1 hour (stale)
                    const hasStaleData = () => {
                        if (!data.weather.cached_fields || !data.weather.cached_fields.timestamp) {
                            return false; // No cached data
                        }

                        const now = new Date();
                        const ONE_HOUR_MS = 60 * 60 * 1000;

                        // Check each timestamp field
                        for (const field in data.weather.cached_fields.timestamp) {
                            if (data.weather.cached_fields.timestamp[field]) {
                                const dataTime = new Date(data.weather.cached_fields.timestamp[field]);
                                const ageMs = now - dataTime;

                                if (ageMs >= ONE_HOUR_MS) {
                                    return true; // Found stale data
                                }
                            }
                        }

                        return false; // No stale data found
                    };

                    // Update data status button based on staleness (over 1 hour old)
                    const dataIsStale = hasStaleData();

                    if (!dataIsStale) {
                        statusBtn.textContent = 'Fresh Data';
                        statusBtn.classList.remove('btn-warning');
                        statusBtn.classList.add('btn-success');
                    } else {
                        statusBtn.textContent = 'Older Data';
                        statusBtn.classList.remove('btn-success');
                        statusBtn.classList.add('btn-warning');
                    }
                    statusBtn.disabled = false; // Enable button once data loads

                    // Format timestamp for display
                    const timeZoneAbbr = (() => {
                        // Get timezone offset
                        const offset = lastUpdated.getTimezoneOffset();
                        const offsetHours = Math.abs(Math.floor(offset / 60));

                        // Check if in DST
                        const jan = new Date(lastUpdated.getFullYear(), 0, 1).getTimezoneOffset();
                        const jul = new Date(lastUpdated.getFullYear(), 6, 1).getTimezoneOffset();
                        const isDST = offset < Math.max(jan, jul);

                        // For Pacific Time
                        if (offset >= 420 && offset <= 480) { // -7 or -8 hours
                            return isDST ? 'PDT' : 'PST';
                        }
                        return `GMT${offset <= 0 ? '+' : '-'}${offsetHours}`;
                    })();

                    // Update cache info in admin UI
                    cacheInfoDiv.innerHTML = `
                        <span class="cache-info">
                            Last updated: ${lastUpdated.toLocaleDateString()} at ${lastUpdated.toLocaleTimeString()} ${timeZoneAbbr}
                            ${data.cache_info.refresh_in_progress ? ' (refresh in progress...)' : ''}
                        </span>`;
                } else {
                    cacheInfoDiv.innerHTML = `<span class="cache-info">Last updated: Unavailable</span>`;
                    statusBtn.textContent = 'Data Status';
                    statusBtn.classList.remove('btn-success', 'btn-warning');
                    statusBtn.classList.add('btn-secondary');
                }

                // Update Data Status Modal content
                const dataStatusModalBody = document.getElementById('dataStatusModalBody');
                let modalHTML = '';
                if (data.modal_content) {
                    if (data.modal_content.note) {
                        modalHTML += `<div class="alert alert-info p-2 small"><strong>NOTE:</strong> ${data.modal_content.note}</div>`;
                    }
                    if (data.modal_content.warning_title && data.modal_content.warning_issues && data.modal_content.warning_issues.length > 0) {
                        modalHTML += `<div class="alert alert-warning p-2 small">
                            <strong>${data.modal_content.warning_title}</strong><br>
                            <ul class="mb-0">
                                ${data.modal_content.warning_issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                }
                if (!modalHTML) {
                    modalHTML = '<p>Data is current and no quality issues detected.</p>'; // Default message
                }
                dataStatusModalBody.innerHTML = modalHTML;

            } catch (error) {
                console.error('Error updating data status:', error);
                document.getElementById('admin-cache-info').innerHTML =
                    `<span class="cache-info text-danger">Error retrieving data status</span>`;

                // Set button to error state
                const statusBtn = document.getElementById('data-status-btn');
                statusBtn.textContent = 'Status Error';
                statusBtn.classList.remove('btn-success', 'btn-secondary');
                statusBtn.classList.add('btn-danger');
                statusBtn.disabled = false;
            }
        }

        async function adminManualRefresh() {
            try {
                // Set button to loading state
                const refreshBtn = document.getElementById('admin-refresh-btn');
                refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
                refreshBtn.disabled = true;

                console.log("Admin manual refresh initiated");

                try {
                    // Request fresh data
                    const response = await fetch('/fire-risk?wait_for_fresh=true', {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }

                    // Successfully retrieved fresh data
                    console.log("Admin refresh successful - received data");

                    // Reset button first
                    refreshBtn.innerHTML = 'Refresh Data';
                    refreshBtn.disabled = false;

                    // Update the data status display
                    await updateDataStatus();

                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = 'Data successfully refreshed!';

                    // Insert the alert after the refresh button
                    refreshBtn.parentNode.insertBefore(alertDiv, refreshBtn.nextSibling);

                    // Remove the alert after 5 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 5000);

                    return true;

                } catch (fetchError) {
                    console.error("Error during admin manual refresh:", fetchError);
                    refreshBtn.innerHTML = 'Refresh Failed - Try Again';
                    refreshBtn.disabled = false;

                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger mt-3';
                    alertDiv.innerHTML = `Refresh failed: ${fetchError.message}`;

                    // Insert the alert after the refresh button
                    refreshBtn.parentNode.insertBefore(alertDiv, refreshBtn.nextSibling);

                    // Remove the alert after 5 seconds
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 5000);

                    return false;
                }
            } catch (error) {
                console.error("Critical error in adminManualRefresh:", error);
                try {
                    document.getElementById('admin-refresh-btn').innerHTML = 'Refresh Failed - Try Again';
                    document.getElementById('admin-refresh-btn').disabled = false;
                } catch (e) {
                    // Nothing more we can do if this fails
                }
                return false;
            }
        }

        // Initialize admin content
        function initializeAdminContent() {
            console.log("Initializing admin dashboard...");

            // Initialize the test mode toggle
            const testModeToggle = document.getElementById('testModeToggle');
            fetchTestModeStatus().then(isTestMode => {
                testModeToggle.checked = isTestMode;
                updateTestModeUI(isTestMode);
            });
            testModeToggle.addEventListener('change', function () {
                toggleTestMode(this.checked);
            });

            // Load subscriber list
            loadSubscribers();

            // Initialize email testing section
            initializeEmailTesting();

            // Initialize data management
            updateDataStatus();

            // Add event listener for data management panel
            document.getElementById('headingDataManagement').addEventListener('click', function () {
                const dataAccordion = document.getElementById('collapseDataManagement');
                if (!dataAccordion.classList.contains('show')) {
                    updateDataStatus();
                }
            });
            
            // Add event listener for testing panel to ensure emails load when opened
            document.getElementById('headingTesting').addEventListener('click', function () {
                const testingAccordion = document.getElementById('collapseTesting');
                if (!testingAccordion.classList.contains('show')) {
                    loadSubscribersForEmails();
                }
            });
        }
    </script>
</body>

</html>
